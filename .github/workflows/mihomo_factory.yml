name: Mihomo Rule Factory

# é˜²æ­¢å·¥ä½œæµå†²çª
concurrency:
  group: mihomo-factory-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '30 0 * * *' # æ¯å¤© UTC 00:30 è¿è¡Œ
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/domain/**'
      - 'src/ip/**'
      - '.github/workflows/mihomo_factory.yml'

permissions:
  contents: write

jobs:
  produce-mrs-rules:
    runs-on: ubuntu-latest
    # é˜²æ­¢å¡æ­»ï¼Œ30åˆ†é’Ÿè¶…æ—¶
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # é‡è¦ï¼šè·å–å®Œæ•´å†å²ï¼Œé¿å…æ¨é€å†²çª
          fetch-depth: 0
      
      - name: è®¾ç½® Docker ç¯å¢ƒ
        run: |
          echo "ğŸ³ æ£€æŸ¥ Docker ç¯å¢ƒ..."
          docker --version
          echo "âœ… Docker å·²å°±ç»ª"

      - name: è½¬æ¢è§„åˆ™æ–‡ä»¶
        run: |
          # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢
          set -e
          echo "ğŸš€ å¼€å§‹å¤„ç† Mihomo è§„åˆ™..."
          
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p "$OUTPUT_DIR"
          
          # æ‹‰å–æœ€æ–°çš„ Mihomo Docker é•œåƒ
          echo "ğŸ“¥ æ‹‰å– Mihomo Docker é•œåƒ..."
          docker pull metacubex/mihomo:latest
          
          # ä½¿ç”¨ Docker è¿è¡Œ Mihomo è½¬æ¢
          DOCKER_CMD="docker run --rm -v $PWD:/workspace --user $(id -u):$(id -g) metacubex/mihomo:latest"
          
          # å¤„ç†åŸŸåè§„åˆ™
          echo "ğŸ“ å¤„ç†åŸŸåè§„åˆ™..."
          for file in "$SOURCE_DIR"/domain/*.list "$SOURCE_DIR"/domain/*.txt; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .list)
            filename=$(basename "$filename" .txt)
            echo "ğŸ”„ è½¬æ¢: $filename"
            $DOCKER_CMD convert-ruleset domain text "/workspace/$file" "/workspace/$OUTPUT_DIR/$filename.mrs" || echo "âš ï¸ è½¬æ¢å¤±è´¥: $filename"
          done
          
          for file in "$SOURCE_DIR"/domain/*.yaml; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .yaml)
            echo "ğŸ”„ è½¬æ¢: $filename"
            $DOCKER_CMD convert-ruleset domain yaml "/workspace/$file" "/workspace/$OUTPUT_DIR/$filename.mrs" || echo "âš ï¸ è½¬æ¢å¤±è´¥: $filename"
          done
          
          # å¤„ç† IP è§„åˆ™
          echo "ğŸ“ å¤„ç†IPè§„åˆ™..."
          for file in "$SOURCE_DIR"/ip/*.list "$SOURCE_DIR"/ip/*.txt; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .list)
            filename=$(basename "$filename" .txt)
            echo "ğŸ”„ è½¬æ¢: $filename"
            $DOCKER_CMD convert-ruleset ipcidr text "/workspace/$file" "/workspace/$OUTPUT_DIR/$filename.mrs" || echo "âš ï¸ è½¬æ¢å¤±è´¥: $filename"
          done
          
          for file in "$SOURCE_DIR"/ip/*.yaml; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .yaml)
            echo "ğŸ”„ è½¬æ¢: $filename"
            $DOCKER_CMD convert-ruleset ipcidr yaml "/workspace/$file" "/workspace/$OUTPUT_DIR/$filename.mrs" || echo "âš ï¸ è½¬æ¢å¤±è´¥: $filename"
          done
          
          echo "âœ… è½¬æ¢å®Œæˆï¼ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -la "$OUTPUT_DIR/"

      - name: æäº¤æ›´æ”¹
        if: success()
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # é‡è¦ä¿®å¤ï¼šå¼ºåˆ¶æ·»åŠ æ‰€æœ‰ .mrs æ–‡ä»¶åˆ° Git è·Ÿè¸ª
          git add -f rule-set/*.mrs
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            git status
          fi
          
          echo "ğŸ“ æäº¤å˜æ›´åˆ°ä»“åº“..."
          git commit -m "Mihomo: æ›´æ–°è§„åˆ™é›† [skip ci]"
          git push
          
          echo "ğŸ‰ æäº¤æˆåŠŸï¼"
