name: Sing-box Rule Factory

# é˜²æ­¢å·¥ä½œæµå†²çª
concurrency:
  group: singbox-factory-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 0 * * *'  
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/*.json'
      - '.github/workflows/singbox_factory.yml'

permissions:
  contents: write

jobs:
  produce-srs-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: å®‰è£… Sing-box
        run: |
          set -e
          echo "ğŸ“¦ å®‰è£… Sing-box..."
          
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ç¡®ä¿ç¨³å®šæ€§
          VERSION="1.12.12"
          
          # ä¸‹è½½å¹¶å®‰è£…
          wget -q --tries=3 --timeout=30 \
            "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz" \
            -O sing-box.tar.gz
          
          tar -zxvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          
          echo "âœ… Sing-box å®‰è£…å®Œæˆ"
          sing-box version

      - name: è¿è¡Œ Sing-box å·¥å‚
        run: |
          SOURCE_DIR="src"
          OUTPUT_DIR="rule-set"
          mkdir -p "$OUTPUT_DIR"
          shopt -s nullglob
          
          # --- è¿œç¨‹è§„åˆ™åˆ—è¡¨ (AdGuard è½¬æ¢) ---
          declare -a REMOTE_FILES=(
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt | AdGuardSDNSFilter"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šè§„åˆ™æº
            # "URL | è§„åˆ™åç§°"
          )
          
          # ----------------------------------------------------------------
          # 1. å¤„ç†è¿œç¨‹ AdGuard è§„åˆ™
          # ----------------------------------------------------------------
          echo ">>> 1. å¤„ç†è¿œç¨‹ AdGuard è§„åˆ™..."
          for rule in "${REMOTE_FILES[@]}"; do
            url="${rule%%|*}"
            name="${rule##*|}"
            url=$(echo "$url" | xargs)
            name=$(echo "$name" | xargs)

            echo "ğŸ“¥ ä¸‹è½½: $name"
            curl --retry 5 --retry-delay 5 -L -s -o "temp_${name}.txt" "$url"

            if [ -f "temp_${name}.txt" ] && [ -s "temp_${name}.txt" ]; then
               sing-box rule-set convert --type adguard --output "${OUTPUT_DIR}/${name}.srs" "temp_${name}.txt" || echo "âš ï¸ è½¬æ¢å¤±è´¥: ${name}"
               echo "âœ… æˆåŠŸ: ${name}.srs"
               rm "temp_${name}.txt"
            else
               echo "âš ï¸ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: $url"
            fi
            echo "---"
          done

          # ----------------------------------------------------------------
          # 2. å¤„ç†æœ¬åœ° JSON è§„åˆ™
          # ----------------------------------------------------------------
          echo ">>> 2. å¤„ç†æœ¬åœ° JSON è§„åˆ™..."
          if [ -d "$SOURCE_DIR" ]; then
            for json_file in "$SOURCE_DIR"/*.json; do
              filename=$(basename "$json_file" .json)
              echo "ğŸ”¨ ç¼–è¯‘ Sing-box JSON: $filename"
              sing-box rule-set compile --output "${OUTPUT_DIR}/${filename}.srs" "$json_file" || echo "âš ï¸ ç¼–è¯‘å¤±è´¥: ${filename}"
            done
          fi
          
          echo "--- æœ€ç»ˆè§„åˆ™é›†ç›®å½•å†…å®¹ ---"
          ls -la "$OUTPUT_DIR/"
          echo "----------------------------------------"

      - name: æäº¤æ›´æ”¹
        if: success()
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰ .srs æ–‡ä»¶åˆ° Git è·Ÿè¸ª
          git add -f rule-set/*.srs
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            git status
          fi
          
          echo "ğŸ“ æäº¤å˜æ›´åˆ°ä»“åº“..."
          git commit -m "Sing-box: æ›´æ–°è§„åˆ™é›† [skip ci]"
          git push
          
          echo "ğŸ‰ æäº¤æˆåŠŸï¼"
