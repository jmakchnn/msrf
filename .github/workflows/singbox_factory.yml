name: Sing-box Rule Factory

# é˜²æ­¢å·¥ä½œæµå†²çª
concurrency:
  group: singbox-factory-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 0 * * *'  
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/*.json'
      - '.github/workflows/singbox_factory.yml'

permissions:
  contents: write

jobs:
  produce-srs-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: å®‰è£… Sing-box
        run: |
          set -e
          echo "ğŸ“¦ å®‰è£… Sing-box..."
          
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ç¡®ä¿ç¨³å®šæ€§
          VERSION="1.12.12"
          
          # ä¸‹è½½å¹¶å®‰è£…
          wget -q --tries=3 --timeout=30 \
            "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz" \
            -O sing-box.tar.gz
          
          tar -zxvf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          
          echo "âœ… Sing-box å®‰è£…å®Œæˆ"
          sing-box version

      - name: ç”Ÿæˆè§„åˆ™é›†
        run: |
          set -e
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆ Sing-box è§„åˆ™é›†..."
          
          OUTPUT_DIR="rule-set"
          mkdir -p "$OUTPUT_DIR"
          
          # å¤„ç†è¿œç¨‹ AdGuard è§„åˆ™
          echo "ğŸŒ ä¸‹è½½è¿œç¨‹è§„åˆ™..."
          curl --retry 3 --retry-delay 2 -L -s \
            "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt" \
            -o adguard_temp.txt
          
          if [ -s "adguard_temp.txt" ]; then
            echo "ğŸ”„ è½¬æ¢ AdGuard è§„åˆ™..."
            sing-box rule-set convert --type adguard \
              --output "${OUTPUT_DIR}/AdGuardSDNSFilter.srs" \
              adguard_temp.txt
            echo "âœ… AdGuard è§„åˆ™è½¬æ¢å®Œæˆ"
            rm adguard_temp.txt
          else
            echo "âš ï¸ AdGuard è§„åˆ™æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡"
            rm -f adguard_temp.txt
          fi
          
          # å¤„ç†æœ¬åœ° JSON è§„åˆ™
          echo "ğŸ“ å¤„ç†æœ¬åœ° JSON è§„åˆ™..."
          for json_file in src/*.json; do
            [ -e "$json_file" ] || continue
            filename=$(basename "$json_file" .json)
            echo "ğŸ”„ ç¼–è¯‘: $filename"
            sing-box rule-set compile \
              --output "${OUTPUT_DIR}/${filename}.srs" \
              "$json_file"
          done
          
          echo "âœ… æ‰€æœ‰è§„åˆ™å¤„ç†å®Œæˆï¼ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -la "$OUTPUT_DIR/"

      - name: æäº¤æ›´æ”¹
        if: success()
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          if git diff --quiet --exit-code -- rule-set/; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          echo "ğŸ“ æäº¤å˜æ›´åˆ°ä»“åº“..."
          git add rule-set/
          git commit -m "Sing-box: æ›´æ–°è§„åˆ™é›† [skip ci]"
          git push
          
          echo "ğŸ‰ æäº¤æˆåŠŸï¼"
